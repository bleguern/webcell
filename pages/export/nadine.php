<?php
        include_once(dirname(__FILE__).'/../../util/sql.php');
        include_once(dirname(__FILE__).'/../../util/util.php');

function export_stock_to_excel() {

        $xls_output = '<TABLE class="data" border=\'0\' name=\'stock\' cellpadding=\'3\' cellspacing=\'1\' style=\'background-color:#d9d9d9\'>
                        <TR>
                                <TD><b>Reference</b></TD>
                                <TD><b>Description</b></TD>
                                <TD><b>Site</b></TD>
                                <TD><b>Quantite</b></TD>
                        </TR>';

        $sql = 'SELECT product.reference, product.name as description, site.trigram as site, SUM(stock.quantity) as quantity ' .
               'FROM product ' .
			   'LEFT OUTER JOIN site ON product.site_id = site.id ' .
			   'LEFT OUTER JOIN stock ON stock.product_id = product.id ' .
			   'WHERE product.reference IN (\'70264-20\', \'240810-20\', \'253285-20\', \'260181-20\', \'260381-20\', \'260481-20\', \'260685-20\', \'260885-20\', \'261180-20\', \'261181-20\', \'261281-20\', \'261380-20\', \'261385-20\', \'261480-20\', \'261581-20\', \'261785-20\', \'262180-20\', \'262280-20\', \'263080-20\', \'263098-20\', \'263180-20\', \'263280-20\', \'263298-20\', \'263380-20\', \'263480-20\', \'263580-20\', \'263680-20\', \'263780-20\', \'263880-20\', \'270181-20\', \'270199-20\', \'270285-20\', \'270299-20\', \'270383-20\', \'270385-20\', \'270399-20\', \'270483-20\', \'270585-20\', \'270685-20\', \'270785-20\', \'271380-20\', \'280150-20\', \'280185-20\', \'280250-20\', \'280285-20\', \'280350-20\', \'280385-20\', \'280450-20\', \'280485-20\', \'280550-20\', \'280585-20\', \'280650-20\', \'280685-20\', \'280750-20\', \'280850-20\', \'280950-20\', \'281001-20\', \'281002-20\', \'281008-20\', \'281009-20\', \'281010-20\', \'281011-20\', \'281014-20\', \'281015-20\', \'281016-20\', \'281017-20\', \'281018-20\', \'281026-20\', \'281027-20\', \'281028-20\', \'281030-20\', \'281031-20\', \'281032-20\', \'281034-20\', \'281035-20\', \'281036-20\', \'281037-20\', \'281040-20\', \'281041-20\', \'281042-20\', \'281043-20\', \'281046-20\', \'281047-20\', \'281049-20\', \'281050-20\', \'281052-20\', \'281053-20\', \'281056-20\', \'281061-20\', \'281062-20\', \'281064-20\', \'281074-20\', \'281075-20\', \'281077-20\', \'281078-20\', \'281080-20\', \'281081-20\', \'281083-20\', \'281084-20\', \'281085-20\', \'281086-20\', \'281087-20\', \'281089-20\', \'281090-20\', \'281091-20\', \'281092-20\', \'281093-20\', \'281094-20\', \'281095-20\', \'281099-20\', \'281100-20\', \'281101-20\', \'281102-20\', \'281109-20\', \'281117-20\', \'281118-20\', \'281121-20\', \'281123-20\', \'281124-20\', \'281125-20\', \'281127-20\', \'281130-20\', \'281131-20\', \'281132-20\', \'281137-20\', \'281140-20\', \'281142-20\', \'281143-20\', \'281147-20\', \'281150-20\', \'281152-20\', \'281153-20\', \'281156-20\', \'281162-20\', \'281164-20\', \'281173-20\', \'281174-20\', \'281175-20\', \'281177-20\', \'281178-20\', \'281180-20\', \'281181-20\', \'281183-20\', \'281184-20\', \'281185-20\', \'281186-20\', \'281187-20\', \'281189-20\', \'281191-20\', \'281192-20\', \'281193-20\', \'281196-20\', \'281200-20\', \'281220-20\', \'281221-20\', \'281223-20\', \'281224-20\', \'281225-20\', \'281243-20\', \'281250-20\', \'281320-20\', \'282025-20\', \'282026-20\', \'282050-20\', \'282150-20\', \'282250-20\', \'282350-20\', \'282450-20\', \'282550-20\', \'282650-20\', \'282750-20\', \'282850-20\', \'282950-20\', \'283002-20\', \'283014-20\', \'283016-20\', \'283017-20\', \'283018-20\', \'283023-20\', \'283024-20\', \'283026-20\', \'283035-20\', \'283036-20\', \'283037-20\', \'283040-20\', \'283041-20\', \'283051-20\', \'283052-20\', \'283056-20\', \'283091-20\', \'283092-20\', \'283095-20\', \'283096-20\', \'283150-20\', \'283250-20\', \'283950-20\', \'284000-20\', \'284018-20\', \'284023-20\', \'284025-20\', \'284150-20\', \'284502-20\', \'284511-20\', \'284530-20\', \'284546-20\', \'284551-20\', \'284552-20\', \'284553-20\', \'284556-20\', \'284577-20\', \'284950-20\', \'285000-20\', \'285001-20\', \'285002-20\', \'285006-20\', \'285007-20\', \'285008-20\', \'285009-20\', \'285010-20\', \'285017-20\', \'285020-20\', \'285021-20\', \'285024-20\', \'285025-20\', \'285027-20\', \'285030-20\', \'285031-20\', \'285032-20\', \'285034-20\', \'285036-20\', \'285041-20\', \'285042-20\', \'285043-20\', \'285052-20\', \'285053-20\', \'285061-20\', \'285062-20\', \'285064-20\', \'285073-20\', \'285074-20\', \'285075-20\', \'285078-20\', \'285080-20\', \'285081-20\', \'285084-20\', \'285085-20\', \'285087-20\', \'285089-20\', \'285093-20\', \'285150-20\', \'285950-20\', \'286000-20\', \'286001-20\', \'286002-20\', \'286006-20\', \'286007-20\', \'286008-20\', \'286009-20\', \'286010-20\', \'286011-20\', \'286015-20\', \'286017-20\', \'286018-20\', \'286020-20\', \'286021-20\', \'286023-20\', \'286024-20\', \'286025-20\', \'286026-20\', \'286027-20\', \'286028-20\', \'286030-20\', \'286031-20\', \'286032-20\', \'286034-20\', \'286035-20\', \'286036-20\', \'286037-20\', \'286041-20\', \'286042-20\', \'286043-20\', \'286046-20\', \'286047-20\', \'286051-20\', \'286052-20\', \'286053-20\', \'286056-20\', \'286057-20\', \'286061-20\', \'286062-20\', \'286064-20\', \'286073-20\', \'286075-20\', \'286077-20\', \'286078-20\', \'286080-20\', \'286081-20\', \'286083-20\', \'286084-20\', \'286085-20\', \'286086-20\', \'286087-20\', \'286089-20\', \'286090-20\', \'286091-20\', \'286092-20\', \'286093-20\', \'286094-20\', \'286095-20\', \'286100-20\', \'286101-20\', \'286102-20\', \'286107-20\', \'286109-20\', \'286110-20\', \'286111-20\', \'286115-20\', \'286118-20\', \'286123-20\', \'286130-20\', \'286131-20\', \'286132-20\', \'286136-20\', \'286140-20\', \'286141-20\', \'286142-20\', \'286143-20\', \'286146-20\', \'286147-20\', \'286149-20\', \'286151-20\', \'286153-20\', \'286173-20\', \'286174-20\', \'286177-20\', \'286178-20\', \'286180-20\', \'286181-20\', \'286185-20\', \'286186-20\', \'286187-20\', \'286190-20\', \'286201-20\', \'286224-20\', \'286240-20\', \'286241-20\', \'286242-20\', \'286249-20\', \'286285-20\', \'286286-20\', \'286287-20\', \'286340-20\', \'286430-20\', \'287900-20\', \'287902-20\', \'287906-20\', \'287907-20\', \'287910-20\', \'287911-20\', \'287930-20\', \'287931-20\', \'287946-20\', \'287947-20\', \'287949-20\', \'287973-20\', \'287977-20\', \'287978-20\', \'287980-20\', \'288000-20\', \'288009-20\', \'288010-20\', \'288020-20\', \'288021-20\', \'288031-20\', \'288032-20\', \'288034-20\', \'288049-20\', \'288062-20\', \'288074-20\', \'288078-20\', \'288080-20\', \'288081-20\', \'288083-20\', \'288086-20\', \'288089-20\', \'288090-20\', \'288093-20\', \'288100-20\', \'288101-20\', \'288108-20\', \'288109-20\', \'288121-20\', \'288132-20\', \'288157-20\', \'288161-20\', \'288162-20\', \'288164-20\', \'288174-20\', \'288175-20\', \'288181-20\', \'288184-20\', \'288185-20\', \'288186-20\', \'288187-20\', \'288189-20\', \'288190-20\', \'288191-20\', \'288194-20\', \'288195-20\', \'288375-20\', \'288409-20\', \'288420-20\', \'288457-20\', \'288464-20\', \'288480-20\', \'288481-20\', \'288489-20\', \'288493-20\', \'289009-20\', \'289016-20\', \'289017-20\', \'289018-20\', \'289023-20\', \'289024-20\', \'289025-20\', \'289028-20\', \'289035-20\', \'289036-20\', \'289037-20\', \'289040-20\', \'289043-20\', \'289051-20\', \'289056-20\', \'289091-20\', \'289137-20\', \'363419-20\', \'405774-20\', \'405876-20\', \'415044-20\', \'435823-20\', \'442860-20\', \'448155-20\', \'448171-20\', \'450799-20\', \'451455-20\', \'459859-20\', \'462490-20\', \'463677-20\', \'466382-20\', \'474360-20\', \'483592-20\', \'484534-20\', \'495603-20\', \'519368-20\', \'537664-20\', \'539742-20\', \'552926-20\', \'552946-20\', \'558137-20\', \'572045-20\', \'574280-20\', \'580273-20\', \'592572-20\', \'594557-20\', \'597073-20\', \'611121-20\', \'612011-20\', \'627358-20\', \'627535-20\', \'628236-20\', \'628269-20\', \'629052-20\', \'631224-20\', \'665073-20\', \'672143-20\', \'691268-20\', \'723201-20\', \'768207-20\', \'769302-20\', \'798066-20\', \'858662-20\', \'900958-20\', \'28100199-20\', \'28104199-20\', \'28104498-20\', \'28108599-20\', \'28114099-20\', \'28118099-20\', \'28118599-20\', \'28301099-20\', \'28301399-20\', \'28302399-20\', \'28304098-20\', \'28304199-20\', \'28402599-20\', \'28500199-20\', \'28504199-20\', \'28508599-20\', \'28602599-20\', \'28603299-20\', \'28604199-20\', \'28604499-20\', \'28608099-20\', \'28608199-20\', \'28610199-20\', \'28612399-20\', \'28618599-20\', \'28628599-20\', \'28798099-20\', \'28800199-20\', \'28818599-20\') ' .
'GROUP BY product.reference ' .
'ORDER BY product.reference, site.trigram';

        $result = mysql_select_query($sql);

        if($result) {

                while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) {

                        $xls_output .= '<TR style=\'background-color:#FFFFFF\' valign=\'center\'>
                                                <TD class="data">'.format_to_reference($row['reference']).'</TD>
                                                <TD class="data">'.$row['description'].'</TD>
                                                <TD class="data">'.$row['site'].'</TD>
                                                <TD class="number">'.format_to_number($row['quantity']).'</TD>
                                        </TR>';
                }
        }

        $xls_output .= '</TABLE>';
        return $xls_output;
}

session_cache_limiter("must-revalidate");
header("Content-type: application/vnd.ms-excel");
header("Content-disposition: attachment; filename=stock_".date("Ymd").".xls");

//session_start();
print export_stock_to_excel();
exit();
?>
